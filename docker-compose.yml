services:
  # ============================================
  # DATABASE SERVICES
  # ============================================

  # PostgreSQL Database (for Player Backend)
  postgres:
    image: postgres:16-alpine
    container_name: neonplay-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-neonplay}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - neonplay-network

  # Redis (for Player Backend caching, sessions, pub/sub)
  redis:
    image: redis:7-alpine
    container_name: neonplay-redis
    restart: unless-stopped
    command: redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - neonplay-network

  # ============================================
  # DATABASE MIGRATIONS
  # ============================================

  # Run Prisma migrations and seed for Player Backend (runs once then exits)
  migrations:
    build:
      context: .
      dockerfile: ./player-backend/Dockerfile
      target: development
    container_name: neonplay-migrations
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-neonplay}
    volumes:
      - ./shared:/app/shared:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - neonplay-network
    command: >
      sh -c "
        echo 'Running Player Backend Prisma db push...' &&
        npx prisma db push --skip-generate &&
        echo 'Running Player Backend database seed...' &&
        npx prisma db seed || echo 'Player Backend seeding skipped or failed' &&
        echo 'Player Backend setup complete!'
      "
    restart: "no"

  # Run Prisma migrations and seed for Admin Backend (runs once then exits)
  admin-migrations:
    build:
      context: .
      dockerfile: ./admin-backend/Dockerfile
    container_name: neonplay-admin-migrations
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-neonplay}
    volumes:
      - ./shared:/app/shared:ro
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    networks:
      - neonplay-network
    command: >
      sh -c "
        echo 'Installing dependencies...' &&
        npm install &&
        echo 'Generating Prisma client...' &&
        npx prisma generate &&
        echo 'Running Admin Backend Prisma db push...' &&
        npx prisma db push --skip-generate &&
        echo 'Running Admin Backend database seed...' &&
        npx prisma db seed || echo 'Admin Backend seeding skipped or failed' &&
        echo 'Admin Backend setup complete!'
      "
    restart: "no"

  # ============================================
  # PLAYER SERVICES (WBC2026 Stack)
  # ============================================

  # Player Backend - NestJS + Prisma + PostgreSQL
  player-backend:
    build:
      context: .
      dockerfile: ./player-backend/Dockerfile
      target: development
    container_name: neonplay-player-backend
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4000
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-neonplay}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-your-access-secret-change-in-production}
      JWT_ACCESS_EXPIRY: ${JWT_ACCESS_EXPIRY:-15m}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-your-refresh-secret-change-in-production}
      JWT_REFRESH_EXPIRY: ${JWT_REFRESH_EXPIRY:-7d}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:8000}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-32-character-encryption-key-here}
      HUIDU_AGENCY_UID: ${HUIDU_AGENCY_UID:-}
      HUIDU_AES_KEY: ${HUIDU_AES_KEY:-}
      HUIDU_SERVER_URL: ${HUIDU_SERVER_URL:-https://jsgame.live}
      HUIDU_CALLBACK_URL: ${HUIDU_CALLBACK_URL:-}
    ports:
      - "4000:4000"
    volumes:
      - ./shared:/app/shared:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/api/v1/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    networks:
      - neonplay-network

  # Player Frontend - React + Vite + TypeScript
  player-frontend:
    build:
      context: ./player-frontend
      dockerfile: Dockerfile
      target: development
    container_name: neonplay-player-frontend
    restart: unless-stopped
    ports:
      - "8000:5173"
    volumes:
      - ./player-frontend/src:/app/src
      - ./player-frontend/public:/app/public
      - /app/node_modules
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:4000/api/v1}
      - VITE_SOCKET_URL=${VITE_SOCKET_URL:-http://localhost:4000}
    depends_on:
      - player-backend
    stdin_open: true
    tty: true
    networks:
      - neonplay-network

  # ============================================
  # ADMIN SERVICES (Original NeonPlay Stack)
  # ============================================

  # Admin Backend - Express.js
  admin-backend:
    build:
      context: .
      dockerfile: ./admin-backend/Dockerfile
    container_name: neonplay-admin-backend
    restart: unless-stopped
    ports:
      - "8002:8002"
    volumes:
      - ./admin-backend:/app
      - ./shared:/app/shared:ro
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - PORT=8002
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-neonplay}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - JWT_SECRET=docker-jwt-secret-change-in-production
      - JWT_EXPIRES_IN=24h
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      admin-migrations:
        condition: service_completed_successfully
    networks:
      - neonplay-network

  # Admin Frontend - React (vanilla JS)
  admin-frontend:
    build:
      context: ./admin-frontend
      dockerfile: Dockerfile
    container_name: neonplay-admin-frontend
    restart: unless-stopped
    ports:
      - "8003:8003"
    volumes:
      - ./admin-frontend/src:/app/src
      - ./admin-frontend/public:/app/public
    environment:
      - PORT=8003
      - REACT_APP_API_URL=${REACT_APP_API_URL:-http://localhost:8002/api}
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    depends_on:
      - admin-backend
    stdin_open: true
    tty: true
    networks:
      - neonplay-network

  # ============================================
  # DEVELOPMENT TOOLS (Optional)
  # ============================================

  # Adminer - Database Management UI
  adminer:
    image: adminer:latest
    container_name: neonplay-adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    networks:
      - neonplay-network
    profiles:
      - dev

  # Redis Commander - Redis Management UI
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: neonplay-redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS: local:redis:6379${REDIS_PASSWORD:+:$REDIS_PASSWORD}
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - neonplay-network
    profiles:
      - dev

volumes:
  postgres_data:
  redis_data:

networks:
  neonplay-network:
    driver: bridge
